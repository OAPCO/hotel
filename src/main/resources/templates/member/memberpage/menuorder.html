<!DOCTYPE html>
<html data-bs-theme="light" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/membermain}" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>메뉴 주문</title>
    <style>
        .btn-outline-dark {
            border-color: lightblue !important;
            border-radius: 0 !important;
        }
        .btn-group-vertical {
            flex-direction: row;
            justify-content: center;
        }
         .card {
             display: flex;
             flex-direction: row;
             margin-bottom: 20px;
             background-color: #fff;
             border-radius: 10px;
             box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
         }
        .card > div.img-container {
            flex: 1;
        }
        .card div.img-container > img {
            max-width: 100%;
            height: auto;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }
        .card > div.text-container {
            flex: 3;
            padding: 20px;
        }
        .card > div.info-container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>

</head>
<body>
<div layout:fragment="content">
    <div id="section1" class="container-fluid pt-5">
        <!-- 메뉴 리스트 -->
        <div class="container" style="margin: auto; width: 80%;">
            <h2>메뉴 주문</h2>
            <!-- 메뉴카테고리 -->
            <div class="btn-group-vertical" role="group" aria-label="Menu categories">
                <button th:each="cate : ${menuCateList}"
                        type="button"
                        class="btn btn-outline-dark flex-fill"
                        th:id="${cate.menuCateIdx}"
                        th:onclick="'changeDetails(\'' + ${cate.menuCateIdx} + '\');'"
                        th:text="${cate.menuCateName}">
                </button>
            </div>
            <div class="menu-list">
                <div th:each="cate : ${menuCateList}">
                    <div class="card" th:each="menu : ${cate.detailMenuDTOList}" th:data-category="${menu.menuCateIdx}" style="display: flex; flex-direction: row; margin-bottom: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);">
                        <!-- 왼쪽 이미지 -->
                        <div style="flex: 1;" class="img-container">
                            <img th:src="|https://${bucket}.s3.${region}.amazonaws.com/${folder}%5c${menu.menuImg}|"
                                 alt="Card image cap"
                                 style="max-width:100%; height: auto; border-top-left-radius: 10px;
             border-bottom-left-radius: 10px;"/>
                        </div>
                        <!-- 가운데 텍스트 -->
                        <div style="flex: 3; padding: 20px;" class="text-container">
                            <h5 class="card-title" th:text="${menu.detailMenuName}"></h5>
                            <p class="card-text" th:text="${menu.menuDescription}"></p>
                            <p class="card-text"><small class="text-muted" th:text="${menu.menuprice}"></small></p>
                        </div>
                        <!-- 오른쪽 정보 -->
                        <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content:
                        space-between;" class="info-container">
                            <div class="badge">추천</div>
                            <button style="background-color: lightblue; border: none; padding: 5px 10px; border-radius: 5px; color: white; font-weight: bold;">장바구니</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="section2" class="container-fluid pt-5">
        <div class="container" style="margin: auto; width: 80%;">
            <h2 class="text-primary">
                주문자 정보
            </h2>
            <div>
                이름: <span th:text="${memberDTO.memberName}"></span>
            </div>
            <div>
                전화번호: <span th:text="${memberDTO.memberPhone}"></span>
            </div>

        </div>
    </div>
    <div id="section3" class="container-fluid pt-5">
        <div class="container" style="margin: auto; width: 80%;">
            <form action="/admin/manager/order/register" method="post">
                <div style="display: none">
                    Idx: <input type="text" th:value="${memberDTO.memberIdx}" name="memberIdx">
                </div>
            <div>
                <h2>장바구니</h2>
                <table class="form-control" style="width: 100%;">
                    <thead>
                    <tr class="row">
                        <th class="col-2">메뉴명</th>
                        <th class="col-3">가격</th>
                        <th class="col-3">주문 개수</th>
                        <th class="col-3">총합</th>
                        <th class="col-1">삭제</th>
                    </tr>
                    </thead>
                    <!-- 추가 정보를 이 곳에 넣어 주세요 -->
                    <tbody id="tableBody">

                    </tbody>
                </table>
            </div>
            <p></p>
            <div class="fa-align-right" style="text-align: right">
                <p style="color: #0c3ee1; ">총 결제액:</p>
            </div>
                <div>

                    <p>요청사항:</p><textarea class="form-control-lg" style="width: 80%;" name="orderRequest"
                              placeholder="요청사항을 입력하세요"></textarea>
                </div>
                <div style="display: none;">
<!--                    주문완료 상태-->
                    <input type="text" name="orderState" value="0">
                    <input id="totalValue" type="text" name="total">
                </div>
            <div>
                <button class="btn btn-outline-primary" type="submit">주문하기</button>
            </div>
            </form>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function() {
            // 오더cd랜덤으로생성
            var uuid = generateUUID();
            $('<input>').attr({
                type: 'hidden',
                id: 'hiddenOrderCd',
                name: 'orderCd',
                value: uuid
            }).appendTo('form');

            function generateUUID() { // UUID v4 generator
                return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                )
            }

            // 장바구니 버튼 클릭 이벤트
            $(".info-container button").click(function() {
                var menuName = $(this).parent().siblings('.text-container').find('.card-title').text();
                var price = parseFloat($(this).parent().siblings('.text-container').find('.text-muted').text());

                var existedRow = null;
                var menuIndex = -1;
                $('#tableBody tr').each(function(index) {
                    if ($(this).children('.col-2').text() === menuName) {
                        existedRow = $(this);
                        menuIndex = index;
                    }
                });

                if (existedRow) {
                    var quantityElem = existedRow.find(".quantity");
                    var valueElem = existedRow.find('.value');
                    var quantity = parseInt(quantityElem.text()) + 1;
                    quantityElem.text(quantity);
                    valueElem.text((price * quantity).toFixed(2));
                    // Update existing hidden field
                    $('#hiddenMenuOrderPrice' + menuIndex).val(price.toFixed(2));
                    // Here we call the calculateTotal function whenever quantity or value is updated
                    calculateTotal();
                } else {
                    // Create new hidden field
                    menuIndex = $('#tableBody tr').length; // Assuming that the menuIndex is the current number of rows
                    var rowHtml = '<tr class="row"><td class="col-2">' + menuName + '</td><td class="col-3"><span>' +
                        price.toFixed(2) + '</span></td><td class="col-3">' +
                        '<button class="btn btn-warning minus">-</button>' +
                        '<span class="quantity">' + '1' + '</span>' +
                        '<button class="btn btn-success plus">+</button>' +
                        '</td><td class="col-3"><span class="value">' +
                        price.toFixed(2) + '</span></td><td class="col-1">' +
                        '<button class="btn btn-danger remove">삭제</button>' +
                        '<input type="hidden" id="hiddenMenuOrderName' + menuIndex + '" name="menuSheets[' + menuIndex + '].menuorderName" value="'+ menuName +'">'+
                        '<input type="hidden" id="hiddenMenuOrderQuantity' + menuIndex + '" name="menuSheets[' + menuIndex + '].menuorderQuantity" value="'+ 1 +'">'+
                        '<input type="hidden" id="hiddenMenuOrderPrice' + menuIndex + '" name="menuSheets[' + menuIndex + '].menuorderPrice" value="'+ price.toFixed(2) +'">'+
                        '<input type="hidden" id="hiddenAmountPrice' + menuIndex + '" name="menuSheets[' + menuIndex + '].AmountPrice" value="'+ price.toFixed(2) +'">'+
                        '</td></tr>';
                    $("#tableBody").append(rowHtml);

                    $(".plus").last().on("click", function() {
                        var quantityElem = $(this).siblings('.quantity');
                        var unitPriceElem = $(this).parent().prev().find('span');
                        var valueElem = $(this).parent().next().find('.value');
                        var quantity = parseInt(quantityElem.text()) + 1;
                        quantityElem.text(quantity);
                        var unitPrice = parseFloat(unitPriceElem.text());
                        valueElem.text((unitPrice * quantity).toFixed(2));
                        // Update hidden field
                        $('#hiddenMenuOrderPrice' + menuIndex).val(price.toFixed(2) * quantity);
                        calculateTotal();
                    });

                    $(".minus").last().on("click", function() {
                        var quantityElem = $(this).siblings('.quantity');
                        var unitPriceElem = $(this).parent().prev().find('span');
                        var valueElem = $(this).parent().next().find('.value');
                        var quantity = parseInt(quantityElem.text()) - 1;
                        if (quantity === 0) {
                            $(this).parent().parent().remove();
                            // Remove hidden field
                            $('#hiddenMenuOrderPrice' + menuIndex).remove();
                            updateMenuIndex();
                            calculateTotal();
                        } else {
                            quantityElem.text(quantity);
                            var unitPrice = parseFloat(unitPriceElem.text());
                            valueElem.text((unitPrice * quantity).toFixed(2));
                            // Update hidden field
                            $('#hiddenMenuOrderPrice' + menuIndex).val(price.toFixed(2) * quantity);
                            calculateTotal();
                        }
                    });

                    $(".remove").last().click(function() {
                        $(this).parents("tr").remove();
                        // Remove hidden field
                        $('#hiddenMenuOrderPrice' + menuIndex).remove();
                        updateMenuIndex();
                        calculateTotal();
                    });
                    // Don't forget to run the calculation when menu is initially added
                    calculateTotal();
                }
            });
        });

        function updateMenuIndex() {
            $("#tableBody tr").each(function(index){
                $(this).find("input[name^='menuSheets']").attr("name", "menuSheets[" + index + "].menuorderPrice");
            });
        }

        function calculateTotal() {
            var total = 0;
            $('#tableBody tr').each(function() {
                var temp = $(this).find(".value").text();
                total += parseFloat(temp);
            });
            total = total.toFixed(2);
            $('.fa-align-right p').text("총 결제액: " + total);
            $('#totalValue').val(total);
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            let menuCategories = Array.from(document.querySelectorAll(".card"));
            let firstCategoryId = menuCategories[0].dataset.category;

            changeDetails(firstCategoryId);
        });

            // 카테고리 누를 시 메뉴 변경
        function changeDetails(categoryId) {
            let menuCards = Array.from(document.querySelectorAll(".card"));

            menuCards.forEach(card => {
                let cardCategory = card.dataset.category;

                if (cardCategory === categoryId) {
                    card.style.display = "flex";
                    card.style.flexDirection = "row";
                    card.style.marginBottom = "20px";
                    card.style.backgroundColor = "#fff";
                    card.style.borderRadius = "10px";
                    card.style.boxShadow = "0px 2px 4px rgba(0, 0, 0, 0.1)";
                } else {
                    card.style.display = "none";
                }
            });
        }

        </script>
</div>
</body>
</html>