<!DOCTYPE html>
<html data-bs-theme="light" lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/main}">
<head>
    <title>매장관리</title>
    <link rel="stylesheet" href="/yhh.css">
</head>
<body>
<div layout:fragment="content">
    <!-- 탭 부분 -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab" aria-controls="payment" aria-selected="true">결제 목록</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="false">매출 추이</button>
        </li>
    </ul>

    <!-- 탭 내용 부분 -->
    <div class="tab-content" id="myTabContent">
        <!-- 결제 목록 탭 -->
        <div class="tab-pane fade show active" id="payment" role="tabpanel" aria-labelledby="payment-tab">
            <div class="card">
                <div class="card-body">
                    <div style="color:#44454e; font-size: 25px; margin-bottom: 10px">
                        결제 목록
                    </div>
                    <!-- 결제 목록 테이블 -->
                    <div class="table-responsive">
                        <!-- 검색 폼 -->
                        <form th:action="@{/admin/manager/storesales}" method="post">
                            <table class="table head">
                                <thead>
                                <tr>
                                    <th>날짜</th>
                                    <td>
                                        <input type="date" name="startDate" id="isoStartDate" style="width: 45%"> ~
                                        <input type="date" name="endDate" id="isoEndDate" style="width: 45%">
                                    </td>

                                    <th>구분</th>
                                    <td>
                                        <input type="radio" name="paymentStatus" value="">전체&nbsp;
                                        <input type="radio" name="paymentStatus" value="0">결제완료&nbsp;
                                        <input type="radio" name="paymentStatus" value="1">결제취소&nbsp;
                                        <input type="radio" name="paymentStatus" value="2">당일취소
                                    </td>
                                </tr>
                                </thead>
                            </table>
                            <div style="text-align: center;">
                                <button type="submit" class="btn btn-primary">조회</button>
                            </div><br>
                        </form>
                        <!-- 결제 목록 출력 테이블 -->
                        <table class="table body" id="resultTable">
                            <thead>
                            <tr>
                                <th>No</th>
                                <th>결제분류</th>
                                <th>결제명</th>
                                <th>결제자</th>
                                <th>전화번호</th>
                                <th>금액</th>
                                <th>구분</th>
                                <th>결제일시</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="data:${paymentDTOS}">
                                <td th:text="${data.paymentIdx}"></td>
                                <td th:text="${data.paymentType}"></td>
                                <td th:text="${data.paymentName}"></td>
                                <td th:text="${data.memberName}"></td>
                                <td th:text="${data.memberPhone}"></td>
                                <td th:text="${data.paymentPrice}"></td>
                                <td th:switch="${data.paymentStatus}">
                                    <span th:case="0" style="color: #2f54cf">결제완료</span>
                                    <span th:case="1" style="color: #b02a37">결제취소</span>
                                    <span th:case="2" style="color: #2f54cf">당일취소</span>
                                </td>
                                <td th:text="${#temporals.format(data.regdate, 'YY-MM-dd / HH:mm')}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 매출 추이 탭 -->
        <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
            <div class="card">
                <div class="card-header">
                    <div style="color:#44454e; font-size: 25px; margin-bottom: 10px">
                        매출 현황
                    </div>

                    총판별 조회
                    <select id="distSelect" style="width: 45%; display: inline-block;" class="form-control">
                        <option value="all">전체</option>
                        <option th:each="distDTO : ${distDTOS}" th:value="${distDTO.distIdx}" th:text="${distDTO.distName}" th:attr="data-dist-idx=${distDTO.distIdx}"></option>
                    </select><br><br>

                    매장별 조회
                    <select style="width: 45%; display: inline-block; " id="storeSelect" class="form-control">
                        <option value="all">전체</option>
                        <option th:each="storeDTO : ${storeDTOS}" th:value="${storeDTO.storeIdx}" th:text="${storeDTO.storeName}" th:attr="data-store-idx=${storeDTO.storeIdx}"></option>
                    </select><br><br>

                    <!-- 매출 셀렉트 박스와 차트 -->
                    <div id="salesDiv">
                        <select class="form-control" id="chartSelect">
                            <option value="year" selected>연간</option>
                            <option value="month">월간</option>
                            <option value="day">일간</option>
                        </select>
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 필요한 JavaScript 라이브러리 및 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/js/hotel.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {


            const allyearlySales = [[${allyearlySales}]];
            const allmonthSales = [[${allmonthSales}]];
            const alldaySales = [[${alldaySales}]];


            var yearlySales; // 연간 매출 데이터를 저장할 변수
            var monthlySales; // 월간 매출 데이터를 저장할 변수
            var dailySales; // 일간 매출 데이터를 저장할 변수
            var chart; // 차트 객체를 저장할 변수

            // 총판 선택 시 이벤트 리스너
            $('#distSelect').on('change', function() {
                var distIdx = $(this).val(); // 선택된 총판의 ID

                $('#storeSelect').val('all');

                if (distIdx === 'all') {
                    // "전체"가 선택된 경우에는 전체 총판에 대한 데이터를 사용합니다.
                    yearlySales = allyearlySales;
                    monthlySales = allmonthSales;
                    dailySales = alldaySales;
                    drawChart();
                } else {
                    // 총판에 해당하는 연간 매출 데이터 가져오기
                    hotel.distYearSalesSearch(distIdx, function(years) {
                        yearlySales = years;
                        console.log("연간매출 : " + yearlySales);
                        drawChart(); // 연간 매출 데이터가 변경되면 차트를 다시 그립니다.
                    });

                    // 총판에 해당하는 월간 매출 데이터 가져오기
                    hotel.distMonthSalesSearch(distIdx, function(months) {
                        monthlySales = months;
                        console.log("월간매출 : " + monthlySales);
                        drawChart(); // 월간 매출 데이터가 변경되면 차트를 다시 그립니다.
                    });

                    // 총판에 해당하는 일간 매출 데이터 가져오기
                    hotel.distDaySalesSearch(distIdx, function(days) {
                        dailySales = days;
                        console.log("일간매출 : " + dailySales);
                        drawChart(); // 일간 매출 데이터가 변경되면 차트를 다시 그립니다.
                    });
                }
            });


            // 매장 선택 시 이벤트 리스너
            $('#storeSelect').on('change', function() {
                var storeIdx = $(this).val(); // 선택된 총판의 ID

                $('#distSelect').val('all');


                if (storeIdx === 'all') {
                    // "전체"가 선택된 경우에는 전체 총판에 대한 데이터를 사용합니다.
                    yearlySales = allyearlySales;
                    monthlySales = allmonthSales;
                    dailySales = alldaySales;
                    drawChart();
                } else {
                    // 총판에 해당하는 연간 매출 데이터 가져오기
                    hotel.storeYearSalesSearch(storeIdx, function(years) {
                        yearlySales = years;
                        console.log("연간매출 : " + yearlySales);
                        drawChart(); // 연간 매출 데이터가 변경되면 차트를 다시 그립니다.
                    });

                    // 총판에 해당하는 월간 매출 데이터 가져오기
                    hotel.storeMonthSalesSearch(storeIdx, function(months) {
                        monthlySales = months;
                        console.log("월간매출 : " + monthlySales);
                        drawChart(); // 월간 매출 데이터가 변경되면 차트를 다시 그립니다.
                    });

                    // 총판에 해당하는 일간 매출 데이터 가져오기
                    hotel.storeDaySalesSearch(storeIdx, function(days) {
                        dailySales = days;
                        console.log("일간매출 : " + dailySales);
                        drawChart(); // 일간 매출 데이터가 변경되면 차트를 다시 그립니다.
                    });
                }
            });



            // 차트 그리기 함수
            function drawChart() {
                var chartSelectVal = $('#chartSelect').val(); // 선택된 차트 종류
                var data = [];
                var labels = [];

                // 선택된 차트 종류에 따라 데이터 설정
                if (chartSelectVal === 'year' && yearlySales) {
                    // 연간 매출 데이터 사용
                    for (var i = 0; i < yearlySales.length; i++) {
                        labels.push(yearlySales[i][0]);
                        data.push(yearlySales[i][1]);
                    }
                } else if (chartSelectVal === 'month' && monthlySales) {
                    // 월간 매출 데이터 사용
                    for (var i = 0; i < monthlySales.length; i++) {
                        labels.push(monthlySales[i][0]);
                        data.push(monthlySales[i][1]);
                    }
                } else if (chartSelectVal === 'day' && dailySales) {
                    // 일간 매출 데이터 사용
                    for (var i = 0; i < dailySales.length; i++) {
                        labels.push(dailySales[i][0]);
                        data.push(dailySales[i][1]);
                    }
                }

                // 차트 객체가 존재하는 경우 파괴
                if (chart) {
                    chart.destroy();
                }

                // 차트가 존재하지 않는 경우에만 새로운 차트 객체 생성
                if (data.length > 0) {
                    var ctx = document.getElementById('salesChart').getContext('2d');
                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '매출',
                                data: data,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }

            // 연간, 월간, 일간 셀렉트박스 변경 시 이벤트 리스너
            $('#chartSelect').on('change', drawChart);
        });


    </script>

</div>
</body>
</html>
