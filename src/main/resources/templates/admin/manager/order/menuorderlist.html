<!DOCTYPE html>
<html data-bs-theme="light" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/manager}">
<head>
  <title>매장관리</title>
  <link rel="stylesheet" href="/yhh.css">
</head>
<body>
<div layout:fragment="content">
  <div class="card" style="margin: 50px 20px;">
  <div class="card-body">
    <div style="color:#44454e; font-size: 25px; margin-bottom: 10px;">
      <h2 class="text-primary">[[${storeName}]] 주문 목록</h2>
    </div>
    <div class="table-responsive">
      <table class="table body" style="width: 100%;">
        <thead>
        <tr>
          <th>No</th>
          <th>객실</th>
          <th>주문코드</th>
          <th>주문액</th>
          <th>주문자</th>
          <th>상태</th>
          <th>주문일시</th>
          <th>주문 상세</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order : ${menuOrderDTOS}">
          <td th:text="${order.menuorderIdx}"></td>
          <td th:text="${order.roomName}"></td>
          <td th:text="${order.menuorderCd}"></td>
          <td th:text="${order.total}"></td>
          <td th:text="${order.memberName}"></td>
          <td>
            <select class="form-control" th:value="${order.orderState}" th:data-menuorder-idx="${order.menuorderIdx}" id="statusSelect">
              <th:block th:if="${order.orderState}==0">
                <option value="0" selected>결제완료</option>
                <option value="1">조리중</option>
                <option value="2">배달완료</option>
              </th:block>
              <th:block th:if="${order.orderState}==1">
                <option value="0">결제완료</option>
                <option value="1" selected>조리중</option>
                <option value="2">배달완료</option>
              </th:block>
              <th:block th:if="${order.orderState}==2">
                <option value="0">결제완료</option>
                <option value="1">조리중</option>
                <option value="2"selected>배달완료</option>
              </th:block>
            </select>
          </td>
<!--          <td th:text="${#strings.substringBefore(order.regdate, 'T')}"></td>-->
          <td th:text="${#temporals.format(order.regdate, 'MM-dd / HH:MM')}"></td>
          <td>
            <button type="button" class="btn btn-outline-info" th:data-target="'#details-' + ${order.menuorderIdx}">주문 상세
            </button>
          </td>

        </tr>



        <th:block th:each="order : ${menuOrderDTOS}">
        <tr th:each="sheet : ${order.menuSheetDTOList}" th:id="'details-' + ${order.menuorderIdx}" style="display: none;">
          <td colspan="9" style="padding: 0;">
            <table style="width: 100%;">
              <thead>
              <tr>
                <th>상세메뉴 번호</th>
                <th>메뉴명</th>
                <th>단일 가격</th>
                <th>갯수</th>
                <th>총 가격</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="sheet : ${order.menuSheetDTOList}">
                <td th:text="${sheet.menuSheetIdx}"></td>
                <td th:text="${sheet.menuorderName}"></td>
                <td th:text="${sheet.menuorderPrice}"></td>
                <td th:text="${sheet.menuorderQuantity}"></td>
                <td th:text="${sheet.amountPrice}"></td>
              </tr>
              </tbody>

              <tr>
                <th style="background-color: #cad5f5" height="60px">요청사항
                <td colspan="6" style="font-size: 22px" th:text="${order.orderRequest}"></td>
                </th>
              </tr>
            </table>
          </td>
        </tr>
        </th:block>


        </tr>
        </tbody>



      </table>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="/js/hotel.js"></script>
  <script>

    var statusSelect = document.getElementById("statusSelect");

    $(document).ready(function(){
      $(".btn-outline-info").click(function(){
        //모든 상세 정보를 숨깁니다.
        $("tr[id^='details-']").hide();

        //상세정보 섹션을 위해 특정한 위치를 설정합니다.
        var detailSection = $(this).data('target');
        var currentRow = $(this).closest('tr');
        $(detailSection).insertAfter(currentRow).show();
      });
    });


    document.querySelectorAll('select[data-menuorder-idx]').forEach(selectElement => {
      selectElement.addEventListener('change', function(e) {
        console.log("셀렉트박스 변함");
        const menuorderIdx = this.getAttribute('data-menuorder-idx');
        const orderStatus = this.value;
        console.log("menuorderIdx: " + menuorderIdx);
        console.log("orderStatus: " + orderStatus);

        // 수정을 위한 AJAX 호출 (예시)
        hotel.menuOrderStatusChange(menuorderIdx, orderStatus);

        setTimeout(function() { location.reload(); }, 1000);
      });
    });

    statusSelect.addEventListener('change', function(e) {

      var row = statusSelect.closest('tr');
      var statusSelectvar = row.querySelector(".statusSelect");

      console.log("셀렉트박스 변함"+row);
      console.log("셀렉트박스 변함"+statusSelectvar);
      const menuorderIdx = this.getAttribute('data-menuorder-idx');
      const orderStatus = statusSelect.value;
      console.log("menuorderIdx"+menuorderIdx);
      console.log("orderStatus"+orderStatus);

        //수정
        hotel.menuOrderStatusChange(menuorderIdx,orderStatus);

        setTimeout(function() {location.reload();}, 1000);

    });


  </script>
</div>
</body>
</html>